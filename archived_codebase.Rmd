---
title: "archived_codechunks"
author: "Jacob Lillelund"
date: "2023-04-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Create country-subsets of data ###
Excluded as we need all data

## EEA Subset (excluding Liechtenstein due to missing data)
```{r}
# Check that the country-names in the below string are exactly as in the world data bank
eea <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czechia", 
                    "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", 
                    "Iceland", "Ireland", "Italy", "Latvia", "Lithuania", 
                    "Luxembourg", "Malta", "Netherlands", "Norway", "Poland", "Portugal", 
                    "Romania", "Slovak Republic", "Slovenia", "Spain", "Sweden", "Switzerland")

# Check number of countries in string
length(eea)

# Filter relevant rows. The number of rows should equal length(eea)*number of variables
worlddatabank_eea <- worlddatabank %>% 
  filter(country %in% eea)
```

## EEA + OECD Subset
```{r}
# List OECD countries 
oecd <- c("Australia", "Austria", "Belgium", "Canada", "Chile", "Colombia",
              "Czechia", "Denmark", "Estonia", "Finland", "France", "Germany",
              "Greece", "Hungary", "Iceland", "Ireland", "Israel", "Italy", "Japan",
              "Korea, Rep.", "Latvia", "Lithuania", "Luxembourg", "Mexico", "Netherlands",
              "New Zealand", "Norway", "Poland", "Portugal", "Slovak Republic", "Slovenia",
              "Spain", "Sweden", "Switzerland", "Turkiye", "United Kingdom", "United States",
              "Costa Rica")

#Create unique string of oecd+eea countries
oecd_eea <- unique(c(oecd, eea))

# Check number of countries in string
length(oecd_eea)
  
# Filter relevant rows. The number of rows should equal length(oecd_eea)*number of variables
worlddatabank_oecd_eea  <- worlddatabank %>% 
  filter(country %in% oecd_eea)
```

# MISSING DATA CALCULATIONS FOR SUBSETS

## EEA
```{r}
# Initiate missing-data dataframe 
missing_data_eea <- tibble(economic_variable)


for (unique_variable in missing_data_eea$economic_variable) {
  
  for (year in c("2013", "2014", "2015", "2016", "2017", "2018", "2019")) {
  
  na <- worlddatabank_eea %>%
            filter(economic_variable == unique_variable) %>% 
            select(year) %>% 
            summarize(num_na = sum(is.na(.)))
  total <- worlddatabank_eea %>%
            filter(economic_variable == unique_variable) %>% 
            select(year) %>% 
            nrow()

  missing_percentage <- as.numeric(na/total)

  missing_data_eea[[year]][missing_data_eea$economic_variable == unique_variable] <- missing_percentage
  }
  
}

missing_data_eea <- rbind(missing_data_eea, c("Mean Missing Percentage", colMeans(missing_data_eea[1:5,2:8])))

missing_data_eea
```

## EEA + OECD
```{r}
# Initiate missing-data dataframe 
missing_data_oecd_eea <- tibble(economic_variable)


for (unique_variable in missing_data_oecd_eea$economic_variable) {
  
  for (year in c("2013", "2014", "2015", "2016", "2017", "2018", "2019")) {
  
  na <- worlddatabank_oecd_eea %>%
            filter(economic_variable == unique_variable) %>% 
            select(year) %>% 
            summarize(num_na = sum(is.na(.)))
  total <- worlddatabank_oecd_eea %>%
            filter(economic_variable == unique_variable) %>% 
            select(year) %>% 
            nrow()

  missing_percentage <- as.numeric(na/total)

  missing_data_oecd_eea[[year]][missing_data_oecd_eea$economic_variable == unique_variable] <- missing_percentage
  }
  
}

missing_data_oecd_eea <- rbind(missing_data_oecd_eea, c("Mean Missing Percentage", colMeans(missing_data_oecd_eea[1:5,2:8])))

missing_data_oecd_eea
```


# DATA FILTER FOR EEA OECD
### Filter final dataset to only include 2019 data for OECD and EEA excluding the Gini-variable
```{r}
worlddatabank_oecd_eea_2019 <- worlddatabank_oecd_eea %>%
  select(country, economic_variable, '2019') %>% 
  filter(economic_variable != "Gini index") %>% 
  rename(value = year )

# Convert into wide-format for later modelling and exploration of data 
worlddatabank_oecd_eea_2019<- worlddatabank_oecd_eea_2019 %>%
  pivot_wider(names_from = economic_variable, values_from = value, id_cols = "country") %>% 
  clean_names() # clean column names
```

# MATCHING DATA FRAMES FOR SUBSETS

```{r}
# Add unique key for each observation to both datasets for fedmatch::merge_plus (function requirement)

worlddatabank_oecd_eea_2019$unique_key_1 <- 1:nrow(worlddatabank_oecd_eea_2019)
freedomhouse_2019$unique_key_2 <- 1:nrow(freedomhouse_2019)

# Merge datasets using merge_plus and the Weighted Jaccard algorithm -
  # NB: Order of dataset matters
fuzzy_result_eea_oecd <- merge_plus(data1 = worlddatabank_oecd_eea_2019, 
                          data2 = freedomhouse_2019,
                          by.x = "country",
                          by.y = "country", match_type = "fuzzy", 
                          fuzzy_settings = build_fuzzy_settings(method = "jw", maxDist = .5),
                          unique_key_1 = "unique_key_1",
                          unique_key_2 = "unique_key_2") 

# Check if any rows did not get a match
print(fuzzy_result_eea_oecd$data1_nomatch)
```
All 43 rows was matched. To make sure that the matching has been done correctly, we inspect those rows that did not have an exact match and verify the match:

```{r}
# Inspect non-exact matches
fuzzy_result_eea_oecd$matches %>%
  filter(country_1 != country_2) %>%
  select(country_1, country_2)
```

All matches but one was done correctly - Korea, Rep. was not matched correctly. A manual inspection of the freedomhouse-data set shows that this is due to different naming: "South Korea".  
This is manually corrected:
```{r}
freedomhouse_2019 <- freedomhouse_2019 %>%
  mutate(country = if_else(country == "South Korea", "Korea, Rep.", country))
```

We can then rerun the script and inspect again:

```{r}
fuzzy_result_eea_oecd <- merge_plus(data1 = worlddatabank_oecd_eea_2019, 
                          data2 = freedomhouse_2019,
                          by.x = "country",
                          by.y = "country", match_type = "fuzzy", 
                          fuzzy_settings = build_fuzzy_settings(method = "jw", maxDist = .5),
                          unique_key_1 = "unique_key_1",
                          unique_key_2 = "unique_key_2") 

# Check if any rows did not get a match
print(fuzzy_result_eea_oecd$data1_nomatch)

# Inspect non-exact matches
fuzzy_result_eea_oecd$matches %>%
  filter(country_1 != country_2) %>%
  select(country_1, country_2)
```
The non-exact matches are all correct, so we save the results to a dataframe and select relevant rows

```{r}
# Save matches to data frame
modelling_data_eea_oecd <- as.data.frame(fuzzy_result_eea_oecd$matches)

# Select and rearrange relevant rows:
modelling_data_eea_oecd <- modelling_data_eea_oecd %>% 
  select("country_1", 
        "gdp_growth_annual_percent", 
        "gdp_per_capita_constant_2015_us",
        "research_and_development_expenditure_percent_of_gdp",
        "tax_revenue_percent_of_gdp",
        "total_natural_resources_rents_percent_of_gdp",
        "total") %>% 
  rename(democracy_score = total, country = country_1)
```

# Models on individual predictors
The model is not very good..? 

We attempt to model only by GDP per Capita and Tax Revenue

```{r}
democracy_score_model_gdp_tax <- lm(democracy_score ~ gdp_per_capita_constant_2015_us + tax_revenue_percent_of_gdp,
                                 data = modelling_data_norm)

tidy(democracy_score_model_gdp_tax) 
glance(democracy_score_model_gdp_tax)

```

We attempt to model only by GDP per capita:
```{r}

# Fit the linear regression model with normalized GDP constant
democracy_score_model_gdp <- lm(democracy_score ~ gdp_per_capita_constant_2015_us,
                                 data = modelling_data_norm)

tidy(democracy_score_model_gdp) 
glance(democracy_score_model_gdp)
```

Modelled only on tax revenue
```{r}
# Fit the linear regression model with normalized Tax Revenue constant
democracy_score_model_tax_revenue <- lm(democracy_score ~ tax_revenue_percent_of_gdp,
                                 data = modelling_data_norm)

tidy(democracy_score_model_tax_revenue) 
glance(democracy_score_model_tax_revenue)
```

# HUGO's code
```{r}

# calculate correlation matrix
corr_matrix <- cor(worlddatabank_numeric)

# calculate VIF values for each variable
vif_values <- vif(lm(gdp_growth_annual_percent ~ gdp_per_capita_constant_2015_us + research_and_development_expenditure_percent_of_gdp + tax_revenue_percent_of_gdp + total_natural_resources_rents_percent_of_gdp, data = worlddatabank_numeric))

# add VIF values to correlation matrix data frame
corr_matrix_with_vif <- cbind(corr_matrix, VIF = vif_values)

# format correlation matrix with VIF values as table
corr_table <- corr_matrix_with_vif %>%
  as.data.frame() %>%
  round(2) %>%
  kable(format = "html", digits = 2, caption = "VIF Matrix") %>%
  kable_paper("hover", full_width = F)
  
# print table
print(corr_table)
```

```{r}
#calculate VIF  scores with each predictor as the dependent variable
vif_values_gdp_growth <- vif(lm(gdp_growth_annual_percent ~ gdp_per_capita_constant_2015_us + research_and_development_expenditure_percent_of_gdp + tax_revenue_percent_of_gdp + total_natural_resources_rents_percent_of_gdp, data = worlddatabank_oecd_eea_numeric))

vif_values_gdp_capita <- vif(lm(gdp_per_capita_constant_2015_us ~ research_and_development_expenditure_percent_of_gdp + tax_revenue_percent_of_gdp + total_natural_resources_rents_percent_of_gdp + gdp_growth_annual_percent, data = worlddatabank_oecd_eea_numeric))

vif_values_rnd <- vif(lm(research_and_development_expenditure_percent_of_gdp ~ tax_revenue_percent_of_gdp + total_natural_resources_rents_percent_of_gdp + gdp_growth_annual_percent + gdp_per_capita_constant_2015_us, data = worlddatabank_oecd_eea_numeric))

vif_values_tax <- vif(lm(tax_revenue_percent_of_gdp ~ total_natural_resources_rents_percent_of_gdp + gdp_growth_annual_percent + gdp_per_capita_constant_2015_us + research_and_development_expenditure_percent_of_gdp, data = worlddatabank_oecd_eea_numeric))

vif_values_tnr <- vif(lm(total_natural_resources_rents_percent_of_gdp ~ gdp_growth_annual_percent + gdp_per_capita_constant_2015_us + research_and_development_expenditure_percent_of_gdp + tax_revenue_percent_of_gdp, data = worlddatabank_oecd_eea_numeric))
```
